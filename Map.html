<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shark Tracker</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.waves.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            transition: background-color 0.5s ease;
            overflow-x: hidden;
        }
        .title-font {
            font-family: 'Orbitron', sans-serif;
        }
        .vanta-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
            z-index: -1;
        }
        .info-card {
            background-color: rgba(31, 41, 55, 0.7);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(75, 85, 99, 0.5);
        }
        .map-card {
            background-color: rgba(31, 41, 55, 0.7);
            border-radius: 1rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(75, 85, 99, 0.5);
        }
        #map {
            height: 500px;
            border-radius: 1rem;
        }
        /* Style for the custom red "Eating" marker */
        .eating-marker {
            background-color: #ef4444; /* red-500 */
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 10px #ef4444;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(0.8); opacity: 0.8; }
        }
        .live-marker {
            background-color: #3b82f6; /* blue-500 */
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px #3b82f6;
        }
    </style>
</head>
<body class="bg-blue-900 text-white">
    <div id="vanta-bg"></div>
    <header class="fixed top-0 left-0 right-0 z-50 p-4 bg-gradient-to-b from-blue-900/80 to-transparent backdrop-blur-sm">
        <nav class="container mx-auto flex justify-between items-center">
            <a href="index.html" class="flex items-center space-x-2">
                <img src="fintrack1.jpg" alt="FinTrack Logo" class="h-10 rounded-lg">
                <span class="text-xl font-bold title-font">FinTrack</span>
            </a>
            <div class="hidden md:flex space-x-6 title-font text-lg">
                <a href="index.html" class="hover:text-blue-400 transition-colors duration-300">Home</a>
                <a href="Map.html" class="hover:text-blue-400 transition-colors duration-300">Map</a>
                <a href="about.html" class="hover:text-blue-400 transition-colors duration-300">About</a>
                <a href="faq.html" class="hover:text-blue-400 transition-colors duration-300">FAQ</a>
                <a href="donate.html" class="hover:text-blue-400 transition-colors duration-300">Donate</a>
                <a href="credits.html" class="hover:text-blue-400 transition-colors duration-300">Credits</a>
            </div>
            <div class="md:hidden">
                <button id="mobile-menu-button" class="text-white focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                </button>
            </div>
        </nav>
    </header>

    <div id="mobile-menu" class="hidden fixed top-0 left-0 right-0 bg-blue-900/90 backdrop-blur-sm z-40 p-6 pt-20 transition-transform transform -translate-y-full md:hidden">
        <nav class="flex flex-col space-y-4 text-center title-font text-xl">
            <a href="index.html" class="hover:text-blue-400 transition-colors duration-300">Home</a>
            <a href="Map.html" class="hover:text-blue-400 transition-colors duration-300">Map</a>
            <a href="about.html" class="hover:text-blue-400 transition-colors duration-300">About</a>
            <a href="faq.html" class="hover:text-blue-400 transition-colors duration-300">FAQ</a>
            <a href="donate.html" class="hover:text-blue-400 transition-colors duration-300">Donate</a>
            <a href="credits.html" class="hover:text-blue-400 transition-colors duration-300">Credits</a>
        </nav>
    </div>

    <main class="container mx-auto max-w-6xl p-6 pt-24 min-h-screen relative z-10">
        <section class="text-center py-8" data-aos="fade-up">
            <h1 class="text-5xl md:text-6xl font-bold title-font text-white">Live Shark Tracker</h1>
            <p class="mt-4 text-xl md:text-2xl text-white-300 max-w-3xl mx-auto">Track the real-time and predicted locations of tagged sharks across the globe.</p>
        </section>

        <section class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8" data-aos="fade-up" data-aos-delay="100">
            <div class="col-span-1 info-card flex flex-col justify-between p-6">
                <div>
                    <h3 class="text-xl font-bold title-font mb-4 text-blue-300">Shark Information</h3>
                    <div id="shark-info">
                        <p class="text-gray-400">Select a shark to view its details.</p>
                    </div>
                </div>
                <div class="mt-4">
                    <h3 class="text-xl font-bold title-font mb-4 text-blue-300">Location Details</h3>
                    <div id="shark-location">
                        <p class="text-gray-400">Location data will be displayed here.</p>
                    </div>
                </div>
                <div class="mt-8">
                    <label for="shark-select" class="block text-xl font-bold title-font text-white mb-2">Select a Shark</label>
                    <div class="relative">
                        <select id="shark-select" class="w-full p-3 bg-gray-800 text-white rounded-lg border border-gray-600 focus:outline-none focus:border-blue-400 transition-colors">
                            <option value="">-- Choose a Shark --</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4">
                    <label class="block text-xl font-bold title-font text-white mb-2">Location Type</label>
                    <div class="flex items-center space-x-4">
                        <span class="text-gray-300">Live</span>
                        <label for="location-switch" class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" value="" id="location-switch" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-500 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                        <span class="text-gray-300">Predicted</span>
                    </div>
                </div>
                <button id="track-shark-btn" class="mt-4 w-full px-6 py-3 text-lg font-bold rounded-lg shadow-lg bg-blue-600 hover:bg-blue-700 transition-colors duration-300">
                    Zoom to Shark
                </button>
                <p id="data-status" class="text-xs text-center mt-2 text-gray-400">Data status: Initializing...</p>
            </div>

            <div class="col-span-2 map-card p-4">
                <div id="map"></div>
            </div>
        </section>

        <section class="py-12" data-aos="fade-up">
            <h2 class="text-4xl font-bold title-font text-center text-white mb-8">About the Data</h2>
            <div class="info-card p-6">
                <p class="text-gray-300">
                    The data displayed on this map is for educational and conservation purposes. Live data is collected from satellite-tagged sharks, providing insights into their migratory patterns and behaviors. Predicted data is generated using advanced algorithms that forecast a shark's likely path based on historical data and environmental factors.
                </p>
                <p class="mt-4 text-gray-300">
                    We work closely with marine biologists and research institutions to ensure the accuracy and integrity of our tracking information. By sponsoring a shark, you directly contribute to the ongoing research and conservation efforts that make this tracking possible.
                </p>
            </div>
        </section>
    </main>

    <footer class="relative z-10 w-full p-6 text-center text-white">
        <p>&copy; 2025 FinTrack. All Rights Reserved. | <a href="credits.html" class="hover:text-blue-400">Credits</a></p>
    </footer>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // =========================================================================
        // ⚠️ DATA CONNECTION CONFIGURATION (CRITICAL)
        // You MUST update this variable with the direct, raw URL to your CSV file
        // in the GitHub repository where the Apps Script is saving data.
        // E.g., https://raw.githubusercontent.com/YourUser/YourRepo/main/data/tracker_log.csv
        // =========================================================================
        const MONOUFYA_SHARK_ID = 'monoufya';
        // 📌 Replace the URL below with your actual RAW CSV file URL
        const RAW_GITHUB_URL = "https://raw.githubusercontent.com/FIntrack-web/FIntrack-data/main/data/tracker_log.csv";
        const INITIAL_VIEW = [30.57, 31.00]; // Center map near Monoufya, Egypt
        
        // Data storage for the live points
        let monoufyaDataPoints = [];
        
        // Global references for UI elements (initialized inside window.onload)
        let sharkSelect;
        let locationSwitch;
        let sharkInfo;
        let sharkLocation;
        let trackSharkBtn;
        let dataStatusElement;


        // Sample data for sharks with a unique color for each
        const sharks = [
            { id: MONOUFYA_SHARK_ID, name: 'Monoufya Shark (Live)', type: 'data', color: '#fcd34d', length: '3.0 m', weight: '350 kg', depth: 'Variable' }, // Amber
            { id: 'shark1', name: 'Great White (Placeholder)', type: 'placeholder', live: [34.0522, -118.2437], predicted: [33.7788, -118.1923], length: '5.5 m', weight: '2,000 kg', depth: '150 m', color: '#ff6347' }, // Tomato
            { id: 'shark2', name: 'Hammerhead (Placeholder)', type: 'placeholder', live: [25.7617, -80.1918], predicted: [26.1224, -80.1373], length: '4.0 m', weight: '500 kg', depth: '50 m', color: '#1e90ff' } // DodgerBlue
        ];

        // Global map components
        let map;
        let markerGroup = L.layerGroup();
        let polylineLayer;

        // --- CSV PARSING AND DATA FETCHING FUNCTIONS ---
        
        function parseCSV(csvString) {
            const lines = csvString.trim().split('\n');
            if (lines.length < 2) return [];

            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                // Regex to handle quoted values containing commas
                const values = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
                if (!values || values.length !== headers.length) continue;

                const row = {};
                values.forEach((val, index) => {
                    // Clean up quotes and trim
                    row[headers[index]] = val.trim().replace(/"/g, '');
                });
                data.push(row);
            }
            return data;
        }
        
        async function fetchSharkData() {
            // Check if the user has replaced the placeholder URL
            if (RAW_GITHUB_URL.includes("FIntrack-data")) { 
                // Using the mock URL for now, but remind the user in the status
                dataStatusElement.textContent = 'Using default mock URL. Replace RAW_GITHUB_URL for live data.';
            }
            
            dataStatusElement.textContent = `Fetching data from remote CSV...`;

            try {
                // Use exponential backoff for fetching data
                const maxRetries = 5;
                let response;
                for (let attempt = 0; attempt < maxRetries; attempt++) {
                    response = await fetch(RAW_GITHUB_URL);
                    if (response.ok) break;
                    if (attempt < maxRetries - 1) {
                        const delay = Math.pow(2, attempt) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }

                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

                const csvText = await response.text();
                const points = parseCSV(csvText);
                
                if (points.length === 0) throw new Error("No tracking data found or CSV is empty.");

                monoufyaDataPoints = points;
                dataStatusElement.textContent = `Live data loaded. Total points: ${points.length}. Last updated: ${new Date().toLocaleTimeString()}`;
                return true;

            } catch (error) {
                console.error("Failed to fetch or process data:", error);
                monoufyaDataPoints = []; // Clear old data on error
                dataStatusElement.textContent = `Error: Failed to fetch live data! (${new Date().toLocaleTimeString()})`;
                return false;
            }
        }
        
        // --- MAP AND UI LOGIC ---

        function createFishIcon(color, className = 'live-marker') {
            return L.divIcon({
                className: className,
                iconSize: [20, 20],
                iconAnchor: [10, 10],
                popupAnchor: [0, -10]
            });
        }

        function clearMapLayers() {
            markerGroup.clearLayers();
            if (polylineLayer) {
                map.removeLayer(polylineLayer);
                polylineLayer = null;
            }
        }

        async function updateMap() {
            clearMapLayers();
            
            const locationType = locationSwitch.checked ? 'predicted' : 'live';
            const selectedSharkId = sharkSelect.value;
            const selectedShark = sharks.find(s => s.id === selectedSharkId);
            
            if (!selectedShark) {
                // Display general info if no shark is selected
                sharkInfo.innerHTML = `<p class="text-gray-400">Select a shark to view its details.</p>`;
                sharkLocation.innerHTML = `<p class="text-gray-400">Location data will be displayed here.</p>`;
                map.setView(INITIAL_VIEW, 2);
                return;
            }
            
            // Update static info card
            sharkInfo.innerHTML = `
                <ul class="space-y-2">
                    <li><strong class="text-blue-200">Name:</strong> ${selectedShark.name}</li>
                    <li><strong class="text-blue-200">Length:</strong> ${selectedShark.length}</li>
                    <li><strong class="text-blue-200">Weight:</strong> ${selectedShark.weight}</li>
                    <li><strong class="text-blue-200">Max Depth:</strong> ${selectedShark.depth}</li>
                </ul>
            `;
            
            if (selectedShark.type === 'data') {
                // === LIVE DATA LOGIC (MONOUFYA SHARK) ===
                const dataReady = await fetchSharkData();
                if (!dataReady || monoufyaDataPoints.length === 0) return;

                const pathCoordinates = monoufyaDataPoints.map(p => [
                    parseFloat(p['Latitude']), 
                    parseFloat(p['Longitude'])
                ]).filter(coords => !isNaN(coords[0]) && !isNaN(coords[1])); // Filter out invalid coordinates
                
                if (pathCoordinates.length === 0) return;

                const latestCoords = pathCoordinates[pathCoordinates.length - 1];
                const latestPoint = monoufyaDataPoints[monoufyaDataPoints.length - 1];
                
                // 1. Plot the path (Polyline)
                polylineLayer = L.polyline(pathCoordinates, { 
                    color: selectedShark.color, 
                    weight: 3, 
                    opacity: 0.7 
                }).addTo(map);

                // 2. Plot the latest point marker
                const diet = latestPoint['Detected Diet'] || 'N/A';
                // Check for specific "eating" indicators in the data
                const isEating = diet !== 'N/A' && diet !== 'No Event Detected' && diet.toLowerCase().includes('feeding'); 
                
                const latestIcon = createFishIcon(selectedShark.color, isEating ? 'eating-marker' : 'live-marker');
                
                const marker = L.marker(latestCoords, { icon: latestIcon }).addTo(markerGroup);

                // 3. Update the dynamic location card
                sharkLocation.innerHTML = `
                    <ul class="space-y-2">
                        <li><strong class="text-blue-200">Time:</strong> ${latestPoint['Timestamp']}</li>
                        <li><strong class="text-blue-200">Lat, Lon:</strong> ${latestCoords[0].toFixed(6)}, ${latestCoords[1].toFixed(6)}</li>
                        <li><strong class="text-blue-200">Depth:</strong> ${parseFloat(latestPoint['Depth (m)'] || 0).toFixed(1)} m</li>
                        <li><strong class="text-blue-200">Activity:</strong> ${diet}</li>
                        <li><strong class="text-blue-200">Accel Mag:</strong> ${parseFloat(latestPoint['Accel Mag (g)'] || 0).toFixed(3)} g</li>
                    </ul>
                `;

                marker.bindPopup(`
                    <b>Monoufya Shark (Latest)</b><br>
                    Time: ${latestPoint['Timestamp']}<br>
                    Activity: ${diet}
                `).openPopup();
                
                // If it's the first load for this shark, zoom to it
                if (sharkSelect.value === MONOUFYA_SHARK_ID) {
                    map.flyTo(latestCoords, 6); // Zoom level 6 is good for global/large area
                }
                
            } else {
                // === PLACEHOLDER DATA LOGIC (Existing code for other sharks) ===
                const coordinates = selectedShark[locationType];
                const sharkIcon = createFishIcon(selectedShark.color, 'live-marker');
                const marker = L.marker(coordinates, {icon: sharkIcon}).addTo(markerGroup);
                
                sharkLocation.innerHTML = `
                    <ul class="space-y-2">
                        <li><strong class="text-blue-200">Type:</strong> ${locationType}</li>
                        <li><strong class="text-blue-200">Latitude:</strong> ${coordinates[0].toFixed(4)}</li>
                        <li><strong class="text-blue-200">Longitude:</strong> ${coordinates[1].toFixed(4)}</li>
                    </ul>
                `;
                
                marker.bindPopup(`<b>${selectedShark.name}</b><br>Coordinates: ${coordinates[0].toFixed(4)}, ${coordinates[1].toFixed(4)}`);
            }
        }

        function zoomToShark() {
            const selectedSharkId = sharkSelect.value;
            if (selectedSharkId) {
                const selectedShark = sharks.find(s => s.id === selectedSharkId);
                let coordinates;

                if (selectedShark.type === 'data' && monoufyaDataPoints.length > 0) {
                    // Zoom to the latest live data point
                    const latestPoint = monoufyaDataPoints[monoufyaDataPoints.length - 1];
                    coordinates = [parseFloat(latestPoint['Latitude']), parseFloat(latestPoint['Longitude'])];
                    map.flyTo(coordinates, 6);
                } else if (selectedShark.type === 'placeholder') {
                    // Zoom to placeholder data
                    const locationType = locationSwitch.checked ? 'predicted' : 'live';
                    coordinates = selectedShark[locationType];
                    map.flyTo(coordinates, 6);
                }
            } else {
                map.flyTo(INITIAL_VIEW, 2);
            }
        }

        // Vanta.js background effect
        VANTA.WAVES({
            el: "body",
            mouseControls: true,
            touchControls: true,
            minHeight: 200.00,
            minWidth: 200.00,
            scale: 1.00,
            scaleMobile: 1.00,
            color: 0x306EEB,
            shininess: 20.00,
            waveHeight: 25.00,
            waveSpeed: 0.7,
            waveCount: 5
        });

        // Initialize AOS and Feather Icons
        AOS.init({
            duration: 800,
            easing: 'ease-in-out',
            once: true
        });
        feather.replace();

        // Mobile menu functionality
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        if (mobileMenuButton) {
            mobileMenuButton.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
                mobileMenu.classList.toggle('transform');
                mobileMenu.classList.toggle('-translate-y-full');
            });
        }

        // Initialize the map and UI elements once the DOM is ready
        window.onload = function() {
            // Assign UI elements here, guaranteeing they exist
            sharkSelect = document.getElementById('shark-select');
            locationSwitch = document.getElementById('location-switch');
            sharkInfo = document.getElementById('shark-info');
            sharkLocation = document.getElementById('shark-location');
            trackSharkBtn = document.getElementById('track-shark-btn');
            dataStatusElement = document.getElementById('data-status');
            
            const mapElement = document.getElementById('map');
            
            if (mapElement) {
                map = L.map('map').setView(INITIAL_VIEW, 2);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                
                markerGroup.addTo(map); // Add marker group to map

                // Populate the dropdown menu
                sharks.forEach(shark => {
                    const option = document.createElement('option');
                    option.value = shark.id;
                    option.textContent = shark.name;
                    sharkSelect.appendChild(option);
                });

                // Set Monoufya Shark as the default selection and load its data
                sharkSelect.value = MONOUFYA_SHARK_ID;
                // Call updateMap() to fetch the CSV data and plot the Monoufya shark
                updateMap(); 
                
                // Set up auto-refresh for the live data
                setInterval(updateMap, 60000); // Refresh every 60 seconds
            }

            // Event Listeners
            if (sharkSelect) sharkSelect.addEventListener('change', updateMap);
            if (locationSwitch) locationSwitch.addEventListener('change', updateMap);
            if (trackSharkBtn) trackSharkBtn.addEventListener('click', zoomToShark);
        };
    </script>
</body>
</html>
